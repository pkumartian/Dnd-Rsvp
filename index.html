<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Adventurers’ Planner</title>

<!-- === PIXELIFY SANS === -->
<style>
@font-face {
  font-family: 'Pixelify Sans';
  src: url('PixelifySans-Bold.ttf') format('truetype');
  font-weight: 700;
}
:root {
  --bg: #e4dec9;
  --parchment: #fcfaf1;
  --ink: #1a1a1a;
  --accent: #5f6d3c;
  --yes: #8dbf7e;
  --maybe: #d0c47d;
  --no: #b7796b;
}
body {
  margin: 0;
  background: var(--bg);
  font-family: 'Pixelify Sans', monospace;
  color: var(--ink);
  font-size: 15px;
  line-height: 1.4;
  transition: background 0.3s, color 0.3s;
}
body.dark {
  --bg: #222;
  --parchment: #2b2b2b;
  --ink: #f3f3f3;
  --accent: #bfa97a;
  --yes: #437d2d;
  --maybe: #bfa97a;
  --no: #86453a;
}
h1 {
  text-align: center;
  padding: 28px 0 12px;
  font-size: 24px;
}
.tabs {
  display: flex;
  justify-content: center;
  margin-bottom: 16px;
}
.tab-btn {
  padding: 8px 28px;
  font-family: inherit;
  background: #ece6d2;
  border: 3px solid var(--accent);
  cursor: pointer;
}
.tab-btn.active {
  background: var(--parchment);
  font-weight: bold;
}
.tab {
  display: none;
  max-width: 800px;
  margin: auto;
  border: 3px solid var(--accent);
  padding: 18px;
  background: var(--parchment);
}
.tab.active { display: block; }
label {
  display: block;
  margin-top: 10px;
}
input, select, button, textarea {
  font-family: inherit;
  font-size: inherit;
  padding: 6px;
  margin-top: 4px;
  border: 2px solid var(--accent);
  background: #fbf9f2;
}
button {
  cursor: pointer;
  margin-top: 12px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 18px;
}
th, td {
  border: 2px solid var(--accent);
  padding: 6px;
  text-align: center;
}
th {
  background: #d8d2b8;
}
.rsvp-btn {
  width: 60px;
  margin: 0 1px;
}
.notice, #toast {
  text-align: center;
  margin-top: 12px;
  color: var(--accent);
}
.hidden { display: none; }
.torch {
  position: absolute;
  top: 36px;
  width: 20px; height: 60px;
  background: #493826;
  border: 2px solid #000;
}
.torch.left { left: 16px; }
.torch.right { right: 16px; }
.torch::before {
  content: '';
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  top: -26px;
  width: 24px; height: 24px;
  background: radial-gradient(circle at 50% 60%, #ffd966 0%, #ff8c00 55%, transparent 70%);
  animation: flicker 0.28s infinite alternate;
  filter: blur(.4px);
}
@keyframes flicker {
  from { transform: translateX(-50%) scale(1); }
  to   { transform: translateX(-50%) scale(1.12); }
}
#toast {
  position: fixed;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--accent);
  color: #fff;
  padding: 8px 16px;
  border-radius: 6px;
  font-weight: bold;
  z-index: 1000;
  transition: opacity 0.5s;
}
@media (max-width: 600px) {
  body { font-size: 13px; }
  h1 { font-size: 18px; }
  .tabs { flex-direction: column; }
  .tab, .tab-btn { padding: 10px; }
  table, th, td { font-size: 12px; padding: 3px; }
  .torch { display: none; }
  .tab { padding: 8px; }
}
.dm-badge {
  background: var(--accent);
  color: #fff;
  border-radius: 6px;
  padding: 2px 6px;
  margin-left: 5px;
  font-size: 12px;
  font-weight: bold;
  vertical-align: top;
}
</style>
</head>
<body>
<div class="torch left"></div><div class="torch right"></div>
<h1>Adventurers’ Planner</h1>
<div style="text-align: right; max-width: 800px; margin: auto;">
  <button id="darkModeBtn" aria-label="Toggle dark mode">Toggle Dark Mode</button>
</div>
<div class="tabs">
  <button class="tab-btn active" data-tab="ledger">Ledger</button>
  <button class="tab-btn" data-tab="calendar">Calendar</button>
</div>
<div id="ledger" class="tab active">
  <label for="charSelect">Select Your Character:</label>
  <select id="charSelect" aria-label="Select your character"></select>
  <span id="dmBadge" class="dm-badge hidden">DM</span>
  <div id="main" class="hidden">
    <label>Date: <input type="date" id="newDate" aria-label="Session date"></label>
    <label>Time: <input type="time" id="newTime" aria-label="Session time"></label>
    <label>Notes: <textarea id="newNotes" aria-label="Session notes" rows="1" style="resize:vertical"></textarea></label>
    <button id="addSession" aria-label="Add session">Add to Ledger</button>
    <table id="ledgerTable" aria-label="Session ledger">
      <thead><tr><th>Date</th><th>Time</th><th>Notes</th><th>Your RSVP</th><th>Delete</th></tr></thead>
      <tbody></tbody>
    </table>
    <details style="margin-top:20px;">
      <summary style="cursor:pointer;font-weight:bold;">View RSVP History</summary>
      <table id="historyTable" style="margin-top:14px;" aria-label="RSVP history">
        <thead><tr><th>Character</th><th>Date</th><th>Time</th><th>RSVP</th><th>Notes</th></tr></thead><tbody></tbody>
      </table>
    </details>
    <div class="notice hidden" id="notice"></div>
    <div style="margin-top:16px;">
      <label for="newChar">Add Character: <input id="newChar" type="text" aria-label="Add character"></label>
      <button id="addChar" aria-label="Add character">Add</button>
      <button id="removeChar" aria-label="Remove selected character">Remove Selected Character</button>
    </div>
    <div style="margin-top:16px;">
      <button id="exportData" aria-label="Export sessions and RSVPs">Export Sessions/RSVPs</button>
      <input type="file" id="importData" aria-label="Import sessions/RSVPs" accept=".json" style="display:none;">
      <button id="importBtn" aria-label="Import sessions/RSVPs">Import</button>
    </div>
  </div>
</div>
<div id="calendar" class="tab">
  <div style="text-align:center;margin-bottom:12px;">
    <button id="prevMonth" aria-label="Previous month">&lt;</button>
    <span id="monthLabel" style="margin:0 12px;font-weight:bold;"></span>
    <button id="nextMonth" aria-label="Next month">&gt;</button>
  </div>
  <div class="cal-days" style="display:grid;grid-template-columns:repeat(7,1fr);text-align:center;margin-bottom:4px;">
    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
  </div>
  <div id="calGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;"></div>
</div>
<div id="toast" class="hidden" role="status" aria-live="polite"></div>
<script>
const DEF_CHARACTERS = ['Kame','Lagros','Mr.DM','Reginald','Shiki','Silo'];
const SESS_KEY='dnd_sessions', CHAR_KEY='dnd_characters', NAME_KEY='dnd_char_name', RSVP_KEY='dnd_rsvp_';
const $=s=>document.querySelector(s);
const load=(k,f)=>{try{return JSON.parse(localStorage.getItem(k))||f;}catch{return f;}};
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const to12 = t=>{const[h,m]=t.split(':').map(Number);
  const suf=h>=12?'PM':'AM'; return ((h+11)%12+1)+':'+String(m).padStart(2,'0')+' '+suf;};
let CHARACTERS=load(CHAR_KEY,DEF_CHARACTERS.slice());
let sessions=load(SESS_KEY,[]);
let char=localStorage.getItem(NAME_KEY)||'';
let calMonth=new Date(); calMonth.setDate(1);
const ledgerTB=$('#ledgerTable tbody'), histTB=$('#historyTable tbody'), noteEl=$('#notice');

// Toast
function showToast(msg) {
  const toast = $('#toast');
  toast.textContent = msg;
  toast.classList.remove('hidden');
  setTimeout(() => toast.classList.add('hidden'), 2000);
}

// Character select rendering
function renderCharSelect() {
  const sel = $('#charSelect');
  sel.innerHTML = `<option value="">-- choose --</option>` + CHARACTERS.map(c =>
    `<option value="${c}">${c}${c==='Kame' ? ' ★' : ''}</option>`
  ).join('');
  sel.value = char;
  $('#dmBadge').classList.toggle('hidden', char !== 'Kame');
}
renderCharSelect();

$('#charSelect').onchange=()=>{
  const val = $('#charSelect').value;
  if (CHARACTERS.includes(val)) {
    char = val;
    localStorage.setItem(NAME_KEY, char);
    $('#main').classList.remove('hidden');
    renderTable(); renderHistory(); renderCalendar();
    $('#dmBadge').classList.toggle('hidden', char !== 'Kame');
  } else {
    $('#main').classList.add('hidden');
    $('#dmBadge').classList.add('hidden');
  }
};

$('#addChar').onclick=()=>{
  const name = $('#newChar').value.trim();
  if (name && !CHARACTERS.includes(name)) {
    CHARACTERS.push(name);
    save(CHAR_KEY, CHARACTERS);
    renderCharSelect();
    showToast(`Character "${name}" added!`);
  } else {
    showToast("Name is empty or already exists.");
  }
  $('#newChar').value='';
};

$('#removeChar').onclick=()=>{
  const selected = $('#charSelect').value;
  if (!selected) { showToast("No character selected."); return; }
  if (selected === 'Kame') { showToast("Cannot remove DM."); return; }
  CHARACTERS = CHARACTERS.filter(c=>c!==selected);
  save(CHAR_KEY, CHARACTERS);
  if (char === selected) {
    char = '';
    localStorage.removeItem(NAME_KEY);
    $('#main').classList.add('hidden');
  }
  renderCharSelect();
  showToast(`Character "${selected}" removed!`);
};

// Add session, with duplicate check
$('#addSession').onclick=()=>{
  const d=$('#newDate').value, t=$('#newTime').value, notes=$('#newNotes').value.trim();
  if(!d||!t){showToast('Pick both date and time.');return;}
  if(sessions.some(s=>s.date===d&&s.time===t)){
    showToast("Session already exists!");
    return;
  }
  sessions.push({date:d,time:t,notes});
  sessions.sort((a,b)=>a.date.localeCompare(b.date)||a.time.localeCompare(b.time));
  save(SESS_KEY,sessions);
  $('#newDate').value=''; $('#newTime').value=''; $('#newNotes').value='';
  renderTable(); renderHistory(); renderCalendar();
  showToast("Session added!");
};

function renderTable(){
  ledgerTB.innerHTML='';
  if(!sessions.length){ledgerTB.innerHTML='<tr><td colspan="5">No sessions yet.</td></tr>';return;}
  const mine=load(RSVP_KEY+char,{});
  sessions.forEach(s=>{
    const key=`${s.date}|${s.time}`, cur=mine[key]||'';
    const canDelete = char==='Kame';
    ledgerTB.insertAdjacentHTML('beforeend',`
      <tr>
        <td>${s.date}</td>
        <td>${to12(s.time)}</td>
        <td>${s.notes||''}</td>
        <td>
          <button class="rsvp-btn" data-k="${key}" data-v="yes" aria-label="RSVP Yes" style="background:${cur==='yes'?'var(--yes)':''}">YES</button>
          <button class="rsvp-btn" data-k="${key}" data-v="maybe" aria-label="RSVP Maybe" style="background:${cur==='maybe'?'var(--maybe)':''}">MAYBE</button>
          <button class="rsvp-btn" data-k="${key}" data-v="no" aria-label="RSVP No" style="background:${cur==='no'?'var(--no)':''}">NO</button>
        </td>
        <td>${canDelete ? `<button class="delete-btn" data-k="${key}" aria-label="Delete session">X</button>` : ''}</td>
      </tr>`);
  });
  document.querySelectorAll('.rsvp-btn').forEach(b=>b.onclick=saveRsvp);
  if (char === 'Kame') {
    document.querySelectorAll('.delete-btn').forEach(b => {
      b.onclick = () => {
        const k = b.dataset.k;
        sessions = sessions.filter(s => `${s.date}|${s.time}` !== k);
        save(SESS_KEY, sessions);
        CHARACTERS.forEach(c => {
          const r = load(RSVP_KEY + c, {});
          delete r[k];
          save(RSVP_KEY + c, r);
        });
        renderTable(); renderHistory(); renderCalendar();
        showToast("Session deleted!");
      };
    });
  }
}

function saveRsvp(){
  const k=this.dataset.k, v=this.dataset.v, obj=load(RSVP_KEY+char,{});
  if(obj[k] === v) {
    delete obj[k];
  } else {
    obj[k] = v;
  }
  save(RSVP_KEY + char, obj);
  noteEl.textContent=`${char} set RSVP to ${obj[k] ? obj[k].toUpperCase() : 'NONE'}.`;
  noteEl.classList.remove('hidden'); setTimeout(()=>noteEl.classList.add('hidden'),1800);
  renderTable(); renderHistory(); renderCalendar();
}

function renderHistory(){
  histTB.innerHTML='';
  if(!sessions.length){histTB.innerHTML='<tr><td colspan="5">No sessions yet.</td></tr>';return;}
  CHARACTERS.forEach(c=>{
    const r=load(RSVP_KEY+c,{});
    sessions.forEach(s=>{
      const key=`${s.date}|${s.time}`, sym=r[key]?r[key].toUpperCase():'';
      histTB.insertAdjacentHTML('beforeend',`<tr>
        <td>${c}${c==='Kame' ? ' <span class="dm-badge">DM</span>' : ''}</td>
        <td>${s.date}</td>
        <td>${to12(s.time)}</td>
        <td>${sym}</td>
        <td>${s.notes||''}</td>
      </tr>`);
    });
  });
}

function renderCalendar(){
  const label=$('#monthLabel'), grid=$('#calGrid');
  const mo=calMonth.getMonth(), yr=calMonth.getFullYear();
  label.textContent=calMonth.toLocaleString('default',{month:'long'})+' '+yr;
  grid.innerHTML='';
  let start=new Date(yr,mo,1).getDay(), days=new Date(yr,mo+1,0).getDate();
  for(let i=0;i<start;i++)grid.innerHTML+='<div></div>';
  for(let d=1;d<=days;d++){
    const dt=`${yr}-${String(mo+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    let match=sessions.filter(s=>s.date===dt);
    // RSVP status indicators
    let rsvpIndicators = match.map(s => {
      let key = `${s.date}|${s.time}`;
      let status = char ? load(RSVP_KEY + char, {})[key] : '';
      if (status === "yes") return "<span style='color:var(--yes);font-weight:bold;' title='YES'>Y</span>";
      if (status === "maybe") return "<span style='color:var(--maybe);font-weight:bold;' title='MAYBE'>M</span>";
      if (status === "no") return "<span style='color:var(--no);font-weight:bold;' title='NO'>N</span>";
      return "<span style='color:var(--accent);font-weight:bold;' title='No RSVP'>?</span>";
    });
    let times = match.map(s => to12(s.time)).join('<br>');
    grid.innerHTML+=`<div style="border:2px solid var(--accent);min-height:60px;padding:4px;">
      <strong>${d}</strong><br>${rsvpIndicators.join(" ")}<br><small>${times}</small></div>`;
  }
}
$('#prevMonth').onclick=()=>{calMonth.setMonth(calMonth.getMonth()-1); renderCalendar();};
$('#nextMonth').onclick=()=>{calMonth.setMonth(calMonth.getMonth()+1); renderCalendar();};

document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
  }
});

// Export/Import
$('#exportData').onclick = () => {
  const data = {
    sessions,
    characters: CHARACTERS,
    rsvps: CHARACTERS.reduce((obj, c) => (obj[c] = load(RSVP_KEY + c, {}), obj), {})
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "dnd_rsvp.json";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  showToast("Data exported!");
};

$('#importBtn').onclick = ()=>$('#importData').click();
$('#importData').onchange = (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const data = JSON.parse(evt.target.result);
      if (Array.isArray(data.sessions)) sessions = data.sessions;
      if (Array.isArray(data.characters)) CHARACTERS = data.characters;
      save(SESS_KEY, sessions);
      save(CHAR_KEY, CHARACTERS);
      if (typeof data.rsvps === "object" && data.rsvps) {
        Object.entries(data.rsvps).forEach(([c, obj])=>save(RSVP_KEY+c, obj));
      }
      renderCharSelect();
      renderTable(); renderHistory(); renderCalendar();
      showToast("Data imported!");
    } catch(e) {
      showToast("Import failed: Invalid JSON");
    }
  };
  reader.readAsText(file);
};

// Dark Mode Toggle
$('#darkModeBtn').onclick = () => {
  document.body.classList.toggle('dark');
  save('dnd_dark_mode', document.body.classList.contains('dark'));
};
if (load('dnd_dark_mode', false)) document.body.classList.add('dark');

// Initial render if needed
if(char && CHARACTERS.includes(char)) {
  $('#main').classList.remove('hidden');
  $('#dmBadge').classList.toggle('hidden', char !== 'Kame');
  renderTable(); renderHistory(); renderCalendar();
}
</script>
</body>
</html>
